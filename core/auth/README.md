# Django REST API with JWT Authentication and 2FA

This is a Django REST API for authentication with JWT and Two-Factor Authentication. It provides endpoints for user registration, login, token refresh, profile retrieval, and 2FA setup and verification.

## Setup

1. Install dependencies:
```bash
pip install -r requirements.txt
```

2. Run migrations:
```bash
python manage.py migrate
```

3. Start the server:
```bash
python manage.py runserver
```

## API Endpoints

### Authentication

#### Register
- **URL**: `/api/register/`
- **Method**: `POST`
- **Body**:
```json
{
    "username": "your_username",
    "email": "your_email@example.com",
    "password": "your_password",
    "password2": "your_password"
}
```
- **Response**: User details and JWT tokens

#### Login
- **URL**: `/api/login/`
- **Method**: `POST`
- **Body**:
```json
{
    "email": "your_email@example.com",
    "password": "your_password"
}
```
- **Response**: JWT tokens

#### Token Refresh
- **URL**: `/api/token/refresh/`
- **Method**: `POST`
- **Body**:
```json
{
    "refresh": "your_refresh_token"
}
```
- **Response**: New access token

#### Profile
- **URL**: `/api/profile/`
- **Method**: `GET`
- **Headers**:
```
Authorization: Bearer your_access_token
```
- **Response**: User profile information

### Two-Factor Authentication (2FA)

The API supports two methods of two-factor authentication:

1. **Time-based One-Time Password (TOTP)** - Uses an authenticator app like Google Authenticator or Authy
2. **Email Verification** - Sends a verification code to the user's email

#### TOTP Setup
- **URL**: `/api/2fa/totp/setup/`
- **Method**: `GET`
- **Headers**:
```
Authorization: Bearer your_access_token
```
- **Response**: TOTP setup information and QR code
- **Description**: This endpoint generates a secret key for the user and returns a QR code that can be scanned with an authenticator app. The QR code is returned as a base64-encoded image.

#### TOTP Verify
- **URL**: `/api/2fa/totp/verify/`
- **Method**: `POST`
- **Headers**:
```
Authorization: Bearer your_access_token
```
- **Body**:
```json
{
    "token": "123456"
}
```
- **Response**: Verification status
- **Description**: This endpoint verifies the 6-digit code generated by the authenticator app. If the code is valid, the user's TOTP device is marked as verified.

#### Email Verification Send
- **URL**: `/api/2fa/email/send/`
- **Method**: `POST`
- **Headers**:
```
Authorization: Bearer your_access_token
```
- **Body**:
```json
{
    "email": "your_email@example.com"
}
```
- **Response**: Confirmation that verification code was sent
- **Description**: This endpoint sends a 6-digit verification code to the user's email. The code is valid for a limited time (typically 10 minutes).

#### Email Verification Confirm
- **URL**: `/api/2fa/email/verify/`
- **Method**: `POST`
- **Headers**:
```
Authorization: Bearer your_access_token
```
- **Body**:
```json
{
    "code": "123456"
}
```
- **Response**: Verification status
- **Description**: This endpoint verifies the 6-digit code sent to the user's email. If the code is valid and not expired, the verification is successful.

## Testing with Postman

### Option 1: Import Collection and Environment

1. **Start the Django server**:
```bash
cd core/auth
python manage.py runserver
```

### 2. Create a new Postman collection
- Open Postman
- Click "New" > "Collection"
- Name it "Django Auth API"

### 3. Test Registration
- Create a new request:
  - Name: "Register"
  - Method: POST
  - URL: `http://localhost:8000/api/register/`
  - Headers: Add `Content-Type: application/json`
  - Body: Select "raw" and choose "JSON"
  - Enter the following JSON:
    ```json
    {
        "first_name": "John",
        "last_name": "Doe",
        "username": "johndoe",
        "email": "john.doe@example.com",
        "password": "testpassword123",
        "password2": "testpassword123"
    }
    ```
- Send the request
- Expected response: 201 Created with user details and tokens
- Save the `access` and `refresh` tokens from the response for later use

### 4. Test Login
- Create a new request:
  - Name: "Login"
  - Method: POST
  - URL: `http://localhost:8000/api/login/`
  - Headers: Add `Content-Type: application/json`
  - Body: Select "raw" and choose "JSON"
  - You can login using either email or username:
    ```json
    {
        "login": "john.doe@example.com",
        "password": "testpassword123"
    }
    ```
    OR
    ```json
    {
        "login": "johndoe",
        "password": "testpassword123"
    }
    ```
- Send the request
- Expected response: 200 OK with access and refresh tokens
- Save the `access` and `refresh` tokens from the response for later use

### 5. Test Profile
- Create a new request:
  - Name: "Profile"
  - Method: GET
  - URL: `http://localhost:8000/api/profile/`
  - Headers: Add `Authorization: Bearer your_access_token` (replace with your actual token)
- Send the request
- Expected response: 200 OK with user profile information

### 6. Test Token Refresh
- Create a new request:
  - Name: "Token Refresh"
  - Method: POST
  - URL: `http://localhost:8000/api/token/refresh/`
  - Headers: Add `Content-Type: application/json`
  - Body: Select "raw" and choose "JSON"
  - Enter the following JSON:
    ```json
    {
        "refresh": "your_refresh_token"
    }
    ```
- Send the request
- Expected response: 200 OK with a new access token
- Save the new access token for later use

### 7. Test TOTP Setup
- Create a new request:
  - Name: "TOTP Setup"
  - Method: GET
  - URL: `http://localhost:8000/api/2fa/totp/setup/`
  - Headers: Add `Authorization: Bearer your_access_token` (use the latest token)
- Send the request
- Expected response: 200 OK with TOTP device information and a QR code
- The response will include a base64-encoded QR code image
- To view the QR code:
  - Copy the base64 string (without quotes)
  - Open a browser and enter: `data:image/png;base64,your_base64_string`
  - Scan the QR code with an authenticator app (Google Authenticator, Authy, etc.)

### 8. Test TOTP Verify
- Create a new request:
  - Name: "TOTP Verify"
  - Method: POST
  - URL: `http://localhost:8000/api/2fa/totp/verify/`
  - Headers: 
    - Add `Content-Type: application/json`
    - Add `Authorization: Bearer your_access_token` (use the latest token)
  - Body: Select "raw" and choose "JSON"
  - Enter the following JSON:
    ```json
    {
        "token": "1234568"
    }
    ```
    (Replace "123456" with the 6-digit code from your authenticator app)
- Send the request
- Expected response: 200 OK with a success message

### 9. Test Email Verification Send
- Create a new request:
  - Name: "Email Verification Send"
  - Method: POST
  - URL: `http://localhost:8000/api/2fa/email/send/`
  - Headers: 
    - Add `Content-Type: application/json`
    - Add `Authorization: Bearer your_access_token` (use the latest token)
  - Body: Select "raw" and choose "JSON"
  - Enter the following JSON:
    ```json
    {
        "email": "postman@example.com"
    }
    ```
- Send the request
- Expected response: 200 OK with a success message
- Check the Django server console for the email with the verification code (since we're using console email backend for testing)

### 10. Test Email Verification Confirm
- Create a new request:
  - Name: "Email Verification Confirm"
  - Method: POST
  - URL: `http://localhost:8000/api/2fa/email/verify/`
  - Headers: 
    - Add `Content-Type: application/json`
    - Add `Authorization: Bearer your_access_token` (use the latest token)
  - Body: Select "raw" and choose "JSON"
  - Enter the following JSON:
    ```json
    {
        "code": "123456"
    }
    ```
- Send the request
- Expected response: 200 OK with a success message